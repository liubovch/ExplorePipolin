---
title: "Phylogenetic Analysis"
author: "Liubov Chuprikova"
date: "5/15/2020"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, results='hide', message=FALSE}
# load packages
library(DECIPHER)
library(dendextend)
library(phytools)
library(ggtree)
library(ggplot2)
library(ape)
```

## Dendextend tanglegrams

```{r}
pipolb_dir = '~/PycharmProjects/ExplorePipolin/data/new_analysis/phylogeny/piPolBs/'
core_dir = '~/PycharmProjects/ExplorePipolin/data/new_analysis/phylogeny/core/'
```

```{r}
dnd_pipolb_mafft <- ReadDendrogram(paste0(pipolb_dir, 'piPolB_concat.MAFFT-L-INS-i.renamed.txt.treefile'))
dnd_pipolb_prank <- ReadDendrogram(paste0(pipolb_dir, 'piPolB_concat.PRANKcodon.renamed.txt.treefile'))

print(cor_cophenetic(dnd_pipolb_mafft, dnd_pipolb_prank, method_coef = 'spearman'))
print(cor_cophenetic(dnd_pipolb_mafft, dnd_pipolb_prank, method_coef = 'pearson'))
```
```{r}
dnd_core_mafft <- ReadDendrogram(paste0(core_dir, 'ROARYwMAFFT.core_gene_alignment.LREC_NCBI.aln.treefile'))
dnd_core_prank <- ReadDendrogram(paste0(core_dir, 'ROARYwPRANK.core_gene_alignment.LREC_NCBI.aln.treefile'))

print(cor_cophenetic(dnd_core_mafft, dnd_core_prank, method_coef = 'spearman'))
print(cor_cophenetic(dnd_core_mafft, dnd_core_prank, method_coef = 'pearson'))
```

```{r}
print(cor_cophenetic(dnd_core_mafft, dnd_pipolb_mafft, method_coef = 'spearman'))
print(cor_cophenetic(dnd_core_prank, dnd_pipolb_prank, method_coef = 'spearman'))

print(cor_cophenetic(dnd_core_mafft, dnd_pipolb_mafft, method_coef = 'pearson'))
print(cor_cophenetic(dnd_core_prank, dnd_pipolb_prank, method_coef = 'pearson'))
```

```{r}
print(entanglement(dnd_core_mafft, dnd_core_prank))
print(entanglement(dnd_pipolb_mafft, dnd_pipolb_prank))
print(entanglement(dnd_core_mafft, dnd_pipolb_mafft))
print(entanglement(dnd_core_prank, dnd_pipolb_prank))
```

```{r}
dndlist_pipolb_core <- dendlist(dnd_core_mafft, dnd_pipolb_mafft)
tanglegram(dndlist_pipolb_core, faster = FALSE, sort = TRUE, 
           margin_inner = 5,
           lab.cex = 0.7, lwd = 1,
           common_subtrees_color_branches = TRUE,
           highlight_branches_lwd = FALSE,
           main_left = 'Core genes', main_right = 'piPolBs'
)
```

### Read metadata and define phylogroups coloring

```{r}
mdir <- '/home/liubov/PycharmProjects/ExplorePipolin/data/new_analysis/phylogeny/'
mdata <- read.csv(paste0(mdir, 'accessions_to_strainnames.tsv'),
                  sep = '\t', header = FALSE, stringsAsFactors = FALSE)
colnames(mdata) <- c('strain', 'accession', 'phylogroup', 'dataset')
mdata$color <- NA
mdata$color[mdata$phylogroup == 'A'] <- 'orange'
mdata$color[mdata$phylogroup == 'B1'] <- 'blue'
mdata$color[mdata$phylogroup == 'C'] <- 'green'
mdata$color[mdata$phylogroup == 'D'] <- 'sienna'

cols <- setNames(mdata$color, mdata$strain)
```

```{r}
dndlist_pipolb_core <- dendlist(dnd_core_mafft, dnd_pipolb_mafft)
tanglegram(dndlist_pipolb_core, faster = FALSE, sort = TRUE, 
           margin_inner = 5, cex_main = 1.5,
           lab.cex = 0.5, lwd = 0.5,
           color_lines = cols[labels(dnd_core_mafft)],
           common_subtrees_color_branches = FALSE,
           highlight_branches_lwd = FALSE,
           main_left = 'Core genes', main_right = 'piPolBs',
           rank_branches = TRUE#, hang = TRUE
)
```

I have a feeling, that tanglegrams are not the same as with phytools, because DECIPHER makes the trees ultrameric and rooted. Probably, DECIPHER + dendextend is not the best choice, as it transforms the original data in the way we don't know.

## Phytools tanglegrams

```{r}
phy_pipolb_mafft <- read.newick(paste0(pipolb_dir, 'piPolB_concat.MAFFT-L-INS-i.renamed.txt.treefile'))
phy_pipolb_prank <- read.newick(paste0(pipolb_dir, 'piPolB_concat.PRANKcodon.renamed.txt.treefile'))
phy_core_mafft <- read.newick(paste0(core_dir, 'ROARYwMAFFT.core_gene_alignment.LREC_NCBI.aln.treefile'))
phy_core_prank <- read.newick(paste0(core_dir, 'ROARYwPRANK.core_gene_alignment.LREC_NCBI.aln.treefile'))
```

```{r}
dataset_info = data.frame(strain = mdata$strain, dataset = mdata$dataset)

grp <- list(A = as.vector(subset(mdata$strain, mdata$phylogroup == 'A')),
            B1 = as.vector(subset(mdata$strain, mdata$phylogroup == 'B1')),
            C = as.vector(subset(mdata$strain, mdata$phylogroup == 'C')),
            D = as.vector(subset(mdata$strain, mdata$phylogroup == 'D')))

tree_core <- ggtree(phy_core_mafft, layout="circular") +
  geom_tiplab(size = 1.5, offset = 0.0002, show.legend = F) +
  geom_treescale()

tree_core <- tree_core %<+% dataset_info + 
  geom_tippoint(aes(color = dataset), size = 0.5, show.legend = F)

groupOTU(tree_core, grp, 'Phylogroup') +
  aes(color = Phylogroup) +
  theme(legend.position = 'right') +
  scale_colour_manual(breaks = c('A','B1', 'C', 'D', 'NCBI', 'LREC'),
                      values=c('grey', 'orange', 'blue',
                               'green', 'sienna', 'red', 'black'))

```

```{r}
phy_tang <- cophylo(phy_core_mafft, phy_pipolb_mafft)
```

```{r}
plot(phy_tang, fsize = 0.2, link.type='curved', link.lty = 'solid', link.lwd = 0.5,
     link.col = cols[phy_tang$assoc[,1]], lwd = 0.5, pts = F, ftype = 'b')
```

```{r}
phy_tang <- cophylo(phy_core_prank, phy_pipolb_prank)
```
```{r}
plot(phy_tang, fsize = 0.2, link.type='curved', link.lty = 'solid', link.lwd = 0.5,
     link.col = cols[phy_tang$assoc[,1]], lwd = 0.5, pts = F, ftype = 'b')
```
```{r}
co_mafft_rf <- cospeciation(phy_core_mafft, phy_pipolb_mafft, nsim = 1000,
                    distance = 'RF', method = 'permutation')

co_mafft_spr <- cospeciation(phy_core_mafft, phy_pipolb_mafft, nsim = 1000,
                    distance = 'SPR', method = 'permutation')

co_prank_rf <- cospeciation(phy_core_prank, phy_pipolb_prank, nsim = 1000,
                    distance = 'RF', method = 'permutation')

co_prank_spr <- cospeciation(phy_core_prank, phy_pipolb_prank, nsim = 1000,
                    distance = 'SPR', method = 'permutation')
```

```{r}
print(paste('MAFFT trees with RF distance:', co_mafft_rf$P.val))
print(paste('MAFFT trees with SPR distance:', co_mafft_spr$P.val))
print(paste('PRANK trees with RF distance:', co_prank_rf$P.val))
print(paste('PRANK trees with SPR distance:', co_prank_spr$P.val))
```

So, we can reject the H0 that there no similarities between trees.

```{r}
phy_core_mafft_A <- drop.tip(
  phy_core_mafft,
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'A')))
phy_core_mafft_AB <- drop.tip(
  phy_core_mafft,
  tip = as.vector(subset(mdata$strain, 
                         mdata$phylogroup != 'A' & mdata$phylogroup != 'B1')))

phy_pipolb_mafft_A <- drop.tip(
  phy_pipolb_mafft, 
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'A')))
phy_pipolb_mafft_AB <- drop.tip(
  phy_pipolb_mafft,
  tip = as.vector(subset(mdata$strain, 
                         mdata$phylogroup != 'A' & mdata$phylogroup != 'B1')))
```

```{r}
co_mafft_rf_A <- cospeciation(phy_core_mafft_A, phy_pipolb_mafft_A, nsim = 1000,
                              distance = 'RF', method = 'permutation')

co_mafft_spr_A <- cospeciation(phy_core_mafft_A, phy_pipolb_mafft_A, nsim = 1000,
                               distance = 'SPR', method = 'permutation')

co_mafft_rf_AB <- cospeciation(phy_core_mafft_AB, phy_pipolb_mafft_AB, nsim = 1000,
                               distance = 'RF', method = 'permutation')

co_mafft_spr_AB <- cospeciation(phy_core_mafft_AB, phy_pipolb_mafft_AB, nsim = 1000,
                                distance = 'SPR', method = 'permutation')
```

```{r}
print(paste('A only: MAFFT trees with RF distance:', co_mafft_rf_A$P.val))
print(paste('A only: MAFFT trees with SPR distance:', co_mafft_spr_A$P.val))
print(paste('AB1 only: MAFFT trees with RF distance:', co_mafft_rf_AB$P.val))
print(paste('AB1 only: MAFFT trees with SPR distance:', co_mafft_spr_AB$P.val))
```

```{r}
phy_core_prank_A <- drop.tip(
  phy_core_prank,
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'A')))
phy_core_prank_AB <- drop.tip(
  phy_core_prank,
  tip = as.vector(subset(mdata$strain, 
                         mdata$phylogroup != 'A' & mdata$phylogroup != 'B1')))

phy_pipolb_prank_A <- drop.tip(
  phy_pipolb_prank, 
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'A')))
phy_pipolb_prank_AB <- drop.tip(
  phy_pipolb_prank,
  tip = as.vector(subset(mdata$strain, 
                         mdata$phylogroup != 'A' & mdata$phylogroup != 'B1')))
```

```{r}
co_prank_rf_A <- cospeciation(phy_core_prank_A, phy_pipolb_prank_A, nsim = 1000,
                              distance = 'RF', method = 'permutation')

co_prank_spr_A <- cospeciation(phy_core_prank_A, phy_pipolb_prank_A, nsim = 1000,
                               distance = 'SPR', method = 'permutation')

co_prank_rf_AB <- cospeciation(phy_core_prank_AB, phy_pipolb_prank_AB, nsim = 1000,
                               distance = 'RF', method = 'permutation')

co_prank_spr_AB <- cospeciation(phy_core_prank_AB, phy_pipolb_prank_AB, nsim = 1000,
                                distance = 'SPR', method = 'permutation')
```

```{r}
print(paste('A only: PRANK trees with RF distance:', co_prank_rf_A$P.val))
print(paste('A only: PRANK trees with SPR distance:', co_prank_spr_A$P.val))
print(paste('AB1 only: PRANK trees with RF distance:', co_prank_rf_AB$P.val))
print(paste('AB1 only: PRANK trees with SPR distance:', co_prank_spr_AB$P.val))
```

When RF distance is used, we reject the H0. But when SPR distance is used, we cannot reject H0 for the trees containing only phylogroup A species => the trees are not congruent.

```{r}
phy_core_mafft_B <- drop.tip(
  phy_core_mafft,
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'B1')))

phy_core_mafft_C <- drop.tip(
  phy_core_mafft,
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'C')))

phy_core_mafft_D <- drop.tip(
  phy_core_mafft,
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'D')))


phy_pipolb_mafft_B <- drop.tip(
  phy_pipolb_mafft, 
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'B1')))

phy_pipolb_mafft_C <- drop.tip(
  phy_pipolb_mafft, 
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'C')))

phy_pipolb_mafft_D <- drop.tip(
  phy_pipolb_mafft, 
  tip = as.vector(subset(mdata$strain, mdata$phylogroup != 'D')))

```

```{r}
co_mafft_rf_B <- cospeciation(phy_core_mafft_B, phy_pipolb_mafft_B, nsim = 1000,
                              distance = 'RF', method = 'permutation')

co_mafft_spr_B <- cospeciation(phy_core_mafft_B, phy_pipolb_mafft_B, nsim = 1000,
                               distance = 'SPR', method = 'permutation')

co_mafft_rf_C <- cospeciation(phy_core_mafft_C, phy_pipolb_mafft_C, nsim = 1000,
                               distance = 'RF', method = 'permutation')

co_mafft_spr_C <- cospeciation(phy_core_mafft_C, phy_pipolb_mafft_C, nsim = 1000,
                                distance = 'SPR', method = 'permutation')

co_mafft_rf_D <- cospeciation(phy_core_mafft_D, phy_pipolb_mafft_D, nsim = 1000,
                               distance = 'RF', method = 'permutation')

co_mafft_spr_D <- cospeciation(phy_core_mafft_D, phy_pipolb_mafft_D, nsim = 1000,
                                distance = 'SPR', method = 'permutation')
```

```{r}
print(paste('B only: MAFFT trees with RF distance:', co_mafft_rf_B$P.val))
print(paste('B only: MAFFT trees with SPR distance:', co_mafft_spr_B$P.val))
print(paste('C only: MAFFT trees with RF distance:', co_mafft_rf_C$P.val))
print(paste('C only: MAFFT trees with SPR distance:', co_mafft_spr_C$P.val))
print(paste('D only: MAFFT trees with RF distance:', co_mafft_rf_D$P.val))
print(paste('D only: MAFFT trees with SPR distance:', co_mafft_spr_D$P.val))
```

Hmm...

## Ape: test the coefficient of concordance

```{r}
core <- cophenetic(phy_core_mafft)
pipolb <- cophenetic(phy_pipolb_mafft)
x <- rownames(core)
pipolb <- pipolb[x, x]
M <- rbind(core, pipolb)
res.global <- CADM.global(M, 2, 92, make.sym = FALSE)
```

```{r}
res.global$congruence_analysis
```

**The matrices are congruent**

```{r}
coreA <- cophenetic(phy_core_mafft_A)
pipolbA <- cophenetic(phy_pipolb_mafft_A)
xA <- rownames(coreA)
pipolbA <- pipolbA[xA, xA]
MA <- rbind(coreA, pipolbA)
resA.global <- CADM.global(MA, 2, 57, make.sym = FALSE)
```
```{r}
resA.global$congruence_analysis
```

**?**

```{r}
coreAB <- cophenetic(phy_core_mafft_AB)
pipolbAB <- cophenetic(phy_pipolb_mafft_AB)
xAB <- rownames(coreAB)
pipolbAB <- pipolbAB[xAB, xAB]
MAB <- rbind(coreAB, pipolbAB)
resAB.global <- CADM.global(MAB, 2, 69, make.sym = FALSE)
```

```{r}
resAB.global$congruence_analysis
```

**?**

```{r}
coreB <- cophenetic(phy_core_mafft_B)
pipolbB <- cophenetic(phy_pipolb_mafft_B)
xB <- rownames(coreB)
pipolbB <- pipolbB[xB, xB]
MB <- rbind(coreB, pipolbB)
resB.global <- CADM.global(MB, 2, 12, make.sym = FALSE)
```

```{r}
resB.global$congruence_analysis
```

**The matrices are congruent**

```{r}
coreC <- cophenetic(phy_core_mafft_C)
pipolbC <- cophenetic(phy_pipolb_mafft_C)
xC <- rownames(coreC)
pipolbC <- pipolbC[xC, xC]
MC <- rbind(coreC, pipolbC)
resC.global <- CADM.global(MC, 2, 8, make.sym = FALSE)
```

```{r}
resC.global$congruence_analysis
```

**?**

```{r}
coreD <- cophenetic(phy_core_mafft_D)
pipolbD <- cophenetic(phy_pipolb_mafft_D)
xD <- rownames(coreD)
pipolbD <- pipolbD[xD, xD]
MD <- rbind(coreD, pipolbD)
resD.global <- CADM.global(MD, 2, 15, make.sym = FALSE)
```

```{r}
resD.global$congruence_analysis
```

**?**

## Outgroups

```{r, echo=FALSE}
# outgroups = c('18-1', 'MRY16-398')

# core_OG_mafft <- 
#   read.newick(paste0(core_dir,
#                      'OGsp_ROARYwMAFFT.core_gene_alignment.LREC_NCBI_OG.aln.treefile'))
# ggtree(core_OG_mafft) + geom_tiplab(size = 1.5,
#                                     aes(color = label %in% outgroups),
#                                     show.legend = F)
# pipolb_OG_mafft <- 
#   read.newick(paste0(pipolb_dir,
#                      'mafft/OGsp_pi-polB_concat.MAFFT-L-INS-i.renamed.txt.treefile'))
# ggtree(pipolb_OG_mafft) + geom_tiplab(size = 1.5,
#                                       aes(color = label %in% outgroups),
#                                       show.legend = F)

```

